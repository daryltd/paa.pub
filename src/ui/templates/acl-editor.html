<h1>Access Policy</h1>

<div class="card">
  <div class="text-muted mb-025">
    Resource: <span class="mono">{{resourceIri}}</span>
  </div>
  {{#isDir}}
  <div class="text-muted text-sm">This policy applies to the container and its contents (unless overridden).</div>
  {{/isDir}}
</div>

<div class="card">
  <h2>Access Level</h2>
  <form method="POST" action="/acp/{{{path}}}">
    <input type="hidden" name="action" value="save_policy">

    <div class="flex-col gap-075 mb-1">
      {{#modeOptions}}
      <label class="mode-option{{#isSelected}} mode-option-selected{{/isSelected}}">
        <input type="radio" name="mode" value="{{value}}" {{{checked}}} class="mt-025">
        <div>
          <div class="font-medium">{{label}}</div>
          <div class="text-muted text-sm">{{description}}</div>
        </div>
      </label>
      {{/modeOptions}}
    </div>

    {{#isInheritMode}}
    <div class="info-box">
      Effective policy: <strong>{{effectiveLabel}}</strong>
      {{#effectiveSource}}
      <span class="text-muted"> â€” inherited from <span class="mono">{{effectiveSource}}</span></span>
      {{/effectiveSource}}
    </div>
    {{/isInheritMode}}

    <div id="custom-agents" class="mb-1{{#customHidden}} hidden{{/customHidden}}">
      <div class="form-group">
        <label for="agents">Allowed WebIDs (one per line)</label>
        <textarea id="agents" name="agents" rows="4" class="mono editor-textarea" placeholder="https://alice.example/profile/card#me">{{agentsText}}</textarea>
      </div>
    </div>

    <div id="inherit-option" class="form-group{{^showInheritCheckbox}} hidden{{/showInheritCheckbox}}">
      <label>
        <input type="checkbox" name="inherit" value="1" {{{inheritChecked}}}>
        Allow children to inherit this policy
      </label>
      <div class="text-muted text-sm mt-025">When unchecked, resources inside this container must set their own policy.</div>
    </div>

    <div class="flex gap-05">
      <button type="submit" class="btn">Save Policy</button>
      <a href="/storage/{{{path}}}" class="btn btn-secondary">Back</a>
    </div>
  </form>

  <script src="/scripts/acl-toggle.js"></script>
</div>

<div class="card">
  <h2>Friends List</h2>
  <p class="text-muted mb-075">
    WebIDs listed here are granted read access when a resource is set to "Friends" mode.
  </p>
  {{#hasFriends}}
  <table class="mb-075">
    {{#friends}}
    <tr>
      <td class="mono text-sm">{{.}}</td>
      <td class="col-action">
        <form method="POST" action="/acp/{{{path}}}" class="inline-form">
          <input type="hidden" name="action" value="remove_friend">
          <input type="hidden" name="webid" value="{{.}}">
          <button type="submit" class="link-btn">remove</button>
        </form>
      </td>
    </tr>
    {{/friends}}
  </table>
  {{/hasFriends}}
  {{^hasFriends}}
  <div class="text-muted mb-075">No friends added yet.</div>
  {{/hasFriends}}

  <form method="POST" action="/acp/{{{path}}}">
    <input type="hidden" name="action" value="add_friend">
    <div class="flex gap-05">
      <input type="url" name="webid" placeholder="https://alice.example/profile/card#me" required class="flex-1">
      <button type="submit" class="btn">Add Friend</button>
    </div>
  </form>
</div>

{{#isDir}}
<div class="card">
  <h2>Storage Quota</h2>
  <p class="text-muted mb-075 text-sm">
    Set a storage limit for this container and its contents.
  </p>
  {{#quotaData}}
  <div class="mb-075">
    <div class="text-md mb-025">
      Used: <strong>{{usedFormatted}}</strong>{{#hasLimit}} / {{limitFormatted}}{{/hasLimit}}
    </div>
    {{#hasLimit}}
    <div class="progress-track">
      <div class="progress-fill {{barColorClass}}" data-percent="{{usedPercent}}"></div>
    </div>
    <script>document.currentScript.previousElementSibling.querySelector('.progress-fill').style.width=document.currentScript.previousElementSibling.querySelector('.progress-fill').dataset.percent+'%';</script>
    {{/hasLimit}}
  </div>
  {{/quotaData}}
  <form method="POST" action="/acp/{{{path}}}">
    <input type="hidden" name="action" value="save_quota">
    <div class="form-group mb-05">
      <label for="quota_limit">Limit (e.g., 500MB, 1GB, or empty for no limit)</label>
      <input type="text" id="quota_limit" name="quota_limit" value="{{quotaLimitValue}}" placeholder="No limit" class="input-short">
    </div>
    <button type="submit" class="btn">Save Quota</button>
  </form>
</div>
{{/isDir}}

<div class="card">
  <h2>ACP Details</h2>
  <details>
    <summary class="text-muted cursor-pointer text-sm">View raw Access Control Policy (Turtle)</summary>
    <pre class="mono code-block mt-05">{{turtlePolicy}}</pre>
  </details>
</div>
